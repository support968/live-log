<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Log</title>
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: black;
      color: #ff2a2a;
      font-family: "Courier New", Courier, monospace;
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #intro {
      text-align: center;
      font-size: 14px;
      margin-bottom: 40px;
      min-height: 40px;
    }

    #input-line {
      display: flex;
      align-items: center;
      font-size: 14px;
      margin-bottom: 30px;
    }

    #cursor {
      width: 10px;
      height: 16px;
      background: #ff2a2a;
      margin-left: 6px;
      animation: blink 1s steps(1) infinite;
    }

    @keyframes blink {
      50% { opacity: 0; }
    }

    #hidden-input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    #logs {
      width: 100%;
      max-width: 520px;
      text-align: center;
      font-size: 13px;
      line-height: 1.6;
    }

    .log {
      opacity: 0;
      animation: drop 0.25s ease-out forwards;
    }

    @keyframes drop {
      from {
        transform: translateY(-8px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>

  <div id="intro"></div>

  <div id="input-line">
    <span id="typed-text"></span>
    <div id="cursor"></div>
  </div>

  <input id="hidden-input" autocomplete="off" />

  <div id="logs"></div>

  <script>
    const intro = document.getElementById("intro");
    const typedText = document.getElementById("typed-text");
    const input = document.getElementById("hidden-input");
    const logsEl = document.getElementById("logs");

    // ─────────────────────
    // INTRO ANIMATION
    // ─────────────────────
    async function typeIntro() {
      await typeText("Wake up", 80);
      await sleep(500);
      await typeDots();
    }

    function typeText(text, speed) {
      return new Promise(resolve => {
        let i = 0;
        const interval = setInterval(() => {
          intro.textContent += text[i];
          i++;
          if (i >= text.length) {
            clearInterval(interval);
            resolve();
          }
        }, speed);
      });
    }

    async function typeDots() {
      for (let i = 0; i < 3; i++) {
        await sleep(600);
        intro.textContent += ".";
      }
    }

    function sleep(ms) {
      return new Promise(r => setTimeout(r, ms));
    }

    // ─────────────────────
    // INPUT + WS
    // ─────────────────────
    const ws = new WebSocket(
      location.protocol === "https:"
        ? `wss://${location.host}`
        : `ws://${location.host}`
    );

    input.focus();
    document.body.addEventListener("click", () => input.focus());

    input.addEventListener("input", () => {
      typedText.textContent = input.value;
    });

    input.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        const text = input.value.trim();
        if (!text) return;
        ws.send(JSON.stringify({ text }));
        input.value = "";
        typedText.textContent = "";
      }
    });

    ws.onmessage = e => {
      const data = JSON.parse(e.data);
      addLog(data);
    };

    async function loadLogs() {
      const res = await fetch("/api/messages");
      const data = await res.json();
      data.reverse().forEach(addLog);
    }

    function addLog({ text, created_at, country }) {
      const d = new Date(created_at);
      const time = d.toLocaleString();

      const el = document.createElement("div");
      el.className = "log";
      el.textContent = `${time} ${country || ""} ${text}`;

      logsEl.prepend(el);
    }

    // INIT
    typeIntro().then(loadLogs);
  </script>
</body>
</html>

