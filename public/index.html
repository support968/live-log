<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>LIVE LOG</title>

<!-- IBM Plex Mono -->
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400&display=swap" 
rel="stylesheet">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  color: #e00000;
  font-family: 'IBM Plex Mono', monospace;
  height: 100%;
}

#screen {
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

#wakeup {
  font-size: 14px;
  margin-bottom: 16px;
  min-height: 20px;
}

#inputLine {
  font-size: 14px;
  height: 20px;
  display: none;
}

#typedText {
  white-space: pre;
}

#cursor {
  display: inline-block;
  width: 2px;              /* ì»¤ì„œ ë‘ê»˜ 30% ê°ì†Œ */
  height: 1em;
  background: #e00000;
  margin-left: 4px;
  animation: blink 1s steps(1) infinite;
}

@keyframes blink {
  50% { opacity: 0; }
}

#logWrapper {
  margin-top: 18px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.log {
  font-size: 13px;
  line-height: 1.55;       /* ë ˆí¼ëŸ°ìŠ¤ì™€ ìœ ì‚¬í•œ í–‰ê°„ */
  letter-spacing: 0.02em; /* ìê°„ */
  opacity: 0;
  transform: translateY(-6px);
  animation: drop 0.35s ease forwards;
}

@keyframes drop {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
</head>

<body>
<div id="screen">
  <div id="wakeup"></div>

  <div id="inputLine">
    <span id="typedText"></span><span id="cursor"></span>
  </div>

  <div id="logWrapper"></div>
</div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1. Wake up íƒ€ì´í•‘
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const wakeupEl = document.getElementById("wakeup");
const inputLine = document.getElementById("inputLine");
const typedTextEl = document.getElementById("typedText");
const logWrapper = document.getElementById("logWrapper");

const wakeupText = "Wake up";
let i = 0;

function typeWakeUp() {
  if (i < wakeupText.length) {
    wakeupEl.textContent += wakeupText[i++];
    setTimeout(typeWakeUp, 120);
  } else {
    typeDots(0);
  }
}

function typeDots(count) {
  if (count < 3) {
    wakeupEl.textContent += ".";
    setTimeout(() => typeDots(count + 1), 400);
  } else {
    setTimeout(() => {
      inputLine.style.display = "block";
      enableTyping();
      loadInitialLogs();
      connectWS();
    }, 500);
  }
}

typeWakeUp();

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   2. íƒ€ì´í•‘ ì…ë ¥ (ì˜ì–´ë§Œ)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let buffer = "";

function enableTyping() {
  document.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      if (!buffer.trim()) return;
      sendLog(buffer.trim());
      buffer = "";
      typedTextEl.textContent = "";
      return;
    }

    if (e.key === "Backspace") {
      buffer = buffer.slice(0, -1);
      typedTextEl.textContent = buffer;
      return;
    }

    if (/^[a-zA-Z0-9 .,!?'-]$/.test(e.key)) {
      buffer += e.key;
      typedTextEl.textContent = buffer;
    }
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   3. ë¡œê·¸ DOM ì¶”ê°€
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderLog({ created_at, country, text }, prepend = false) {
  const d = new Date(created_at);
  const line = document.createElement("div");
  line.className = "log";
  line.textContent =
    `${d.toLocaleString("en-US")} ${country} ${text}`;

  if (prepend) {
    logWrapper.prepend(line);
  } else {
    logWrapper.appendChild(line);
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   4. ì´ˆê¸° ë¡œê·¸ ë¡œë“œ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function loadInitialLogs() {
  const res = await fetch("/api/messages");
  const data = await res.json();

  data
    .sort((a, b) => b.created_at - a.created_at)
    .forEach(item => renderLog(item, false));
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   5. WebSocket ì‹¤ì‹œê°„ ìˆ˜ì‹ 
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let ws;

function connectWS() {
  ws = new WebSocket(
    location.protocol === "https:"
      ? `wss://${location.host}`
      : `ws://${location.host}`
  );

  ws.onmessage = e => {
    const data = JSON.parse(e.data);
    renderLog(data, true); // ğŸ”¥ ì¦‰ì‹œ í™”ë©´ì— ì¶”ê°€
  };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   6. ë¡œê·¸ ì „ì†¡
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function sendLog(text) {
  await fetch("/api/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text })
  });
}
</script>
</body>
</html>

