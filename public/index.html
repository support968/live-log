<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LIVE LOG</title>

<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400&display=swap"
rel="stylesheet">

<style>
* {
  box-sizing: border-box;
}

html {
  overflow: hidden !important;
  height: 100vh !important;
  width: 100vw !important;
  margin: 0 !important;
  padding: 0 !important;
}

body {
  overflow: hidden !important;
  height: 100vh !important;
  width: 100vw !important;
  margin: 0 !important;
  padding: 0 !important;
  background: #000;
  color: #e00000;
  font-family: 'IBM Plex Mono', monospace;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
}

#screen {
  height: 100vh;
  width: 100vw;
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow: hidden;
}

#header {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  z-index: 10;
}

#wakeup {
  font-size: 14px;
  margin-bottom: 0px;
}

#inputLine {
  font-size: 14px;
  height: 20px;
  display: none;
}

#typedText {
  white-space: pre;
}

#cursor {
  display: inline-block;
  width: 2px;
  height: 1em;
  background: #e00000;
  margin-left: 4px;
  animation: blink 1s steps(1) infinite;
}

@keyframes blink {
  50% { opacity: 0; }
}

#logWrapper {
  position: absolute;
  top: calc(50% + 20px);
  left: 0;
  right: 0;
  bottom: 0;
  overflow-y: auto;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  padding: 0 20px 0 20px;
  scrollbar-width: none;
  -ms-overflow-style: none;
}

#logWrapper::-webkit-scrollbar {
  display: none;
}

.log {
  font-size: 13px;
  line-height: 1.2;
  letter-spacing: 0.02em;
  opacity: 0;  
  transform: translateY(-6px);
  animation: drop 0.35s ease forwards;
  text-align: center;
  margin-bottom: 0;
}

@keyframes drop {
  to {   
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
</head>
 
<body>
<script>
document.documentElement.style.overflow = 'hidden';
document.body.style.overflow = 'hidden';
</script>

<div id="screen"> 
  <div id="header">  
    <div id="wakeup"></div>
    <div id="inputLine">
      <span id="typedText"></span><span id="cursor"></span>
    </div>
  </div>
  
  <div id="logWrapper"></div>
</div>

<script>
const wakeupEl = document.getElementById("wakeup");
const inputLine = document.getElementById("inputLine");
const typedTextEl = document.getElementById("typedText");
const logWrapper = document.getElementById("logWrapper");
      
const wakeupText = "Wake up";
let i = 0;
let lastSentTime = 0;
     
function typeWakeUp() {
  if (i < wakeupText.length) {  
    wakeupEl.textContent += wakeupText[i++];
    setTimeout(typeWakeUp, 120);
  } else {   
    typeDots(0);
  }
}
      
function typeDots(count) {
  if (count < 3) {
    wakeupEl.textContent += ".";
    setTimeout(() => typeDots(count + 1), 500);
  } else {
    setTimeout(() => {
      inputLine.style.display = "block";
      enableTyping();
      connectWS();
  
      setTimeout(() => {
        loadInitialLogs();
      }, 2000);
  
    }, 500);
  }
}
  
typeWakeUp();
    
let buffer = "";  
let isTyping = false;
    
function enableTyping() {
  document.addEventListener("keydown", e => {
    if (isTyping) return;
    
    if (e.key === "Enter") {
      if (!buffer.trim()) return;
      isTyping = true;
      sendLog(buffer.trim());
      buffer = "";
      typedTextEl.textContent = "";
      return;
    }
    
    if (e.key === "Backspace") {
      buffer = buffer.slice(0, -1);
      typedTextEl.textContent = buffer;
      return;
    }
   
    if (e.key.length === 1) {
      buffer += e.key;
      typedTextEl.textContent = buffer;
    }
  });
}
  
function renderLog({ created_at, country, text }, isNew = false) {
  const d = new Date(created_at);
      
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  const year = d.getFullYear();
  const hours = String(d.getHours()).padStart(2, '0');
  const minutes = String(d.getMinutes()).padStart(2, '0');
  const seconds = String(d.getSeconds()).padStart(2, '0');
    
  const timestamp = `${month}/${day}/${year}, ${hours}:${minutes}:${seconds}`;
  
  const countryNames = {
    'KR': 'South Korea',
    'US': 'United States',
    'JP': 'Japan',
    'CN': 'China',   
    'GB': 'United Kingdom',
    'DE': 'Germany',
    'FR': 'France',
    'CA': 'Canada',
    'AU': 'Australia',
    'IT': 'Italy',
    'ES': 'Spain',
    'BR': 'Brazil',   
    'MX': 'Mexico',
    'IN': 'India',
    'RU': 'Russia',
    'NL': 'Netherlands',
    'SE': 'Sweden',
    'CH': 'Switzerland',
    'SG': 'Singapore',
    'TH': 'Thailand',
    'VN': 'Vietnam',
    'PH': 'Philippines',
    'ID': 'Indonesia',
    'MY': 'Malaysia',
    'TW': 'Taiwan',
    'HK': 'Hong Kong',
    'NZ': 'New Zealand',
    'AR': 'Argentina',
    'CL': 'Chile',
    'CO': 'Colombia',
    'PE': 'Peru',
    'ZA': 'South Africa',
    'EG': 'Egypt',
    'SA': 'Saudi Arabia',
    'AE': 'UAE',
    'TR': 'Turkey',
    'PL': 'Poland',
    'PT': 'Portugal',
    'BE': 'Belgium',
    'AT': 'Austria',
    'NO': 'Norway',
    'DK': 'Denmark',
    'FI': 'Finland',
    'IE': 'Ireland',
    'CZ': 'Czech Republic',
    'GR': 'Greece',
    'IL': 'Israel'
  };
    
  const countryName = countryNames[country] || country;
    
  const line = document.createElement("div");
  line.className = "log";
  line.textContent = `${timestamp} ${countryName} ${text}`;
    
  if (isNew) {
    logWrapper.prepend(line);
  } else {
    logWrapper.appendChild(line);
  }
}

async function loadInitialLogs() {
  const res = await fetch("/api/messages");
  const data = await res.json();
    
  const sorted = data.sort((a, b) => b.created_at - a.created_at);
    
  for (let i = 0; i < sorted.length; i++) {
    setTimeout(() => {
      const logDiv = document.createElement("div");
      logDiv.className = "log";
      const d = new Date(sorted[i].created_at);
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const year = d.getFullYear();
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      const seconds = String(d.getSeconds()).padStart(2, '0');
      const timestamp = `${month}/${day}/${year}, ${hours}:${minutes}:${seconds}`;
      
      const countryNames = {
        'KR': 'South Korea',
        'US': 'United States',
        'JP': 'Japan',
        'CN': 'China',
        'GB': 'United Kingdom',
        'DE': 'Germany',
        'FR': 'France',
        'CA': 'Canada',
        'AU': 'Australia',
        'IT': 'Italy',
        'ES': 'Spain',
        'BR': 'Brazil',
        'MX': 'Mexico',
        'IN': 'India',
        'RU': 'Russia',
        'NL': 'Netherlands',
        'SE': 'Sweden',
        'CH': 'Switzerland',
        'SG': 'Singapore',
        'TH': 'Thailand',
        'VN': 'Vietnam',
        'PH': 'Philippines',
        'ID': 'Indonesia',
        'MY': 'Malaysia',
        'TW': 'Taiwan',
        'HK': 'Hong Kong',
        'NZ': 'New Zealand',
        'AR': 'Argentina',
        'CL': 'Chile',
        'CO': 'Colombia',
        'PE': 'Peru',
        'ZA': 'South Africa',
        'EG': 'Egypt',
        'SA': 'Saudi Arabia',
        'AE': 'UAE',
        'TR': 'Turkey',
        'PL': 'Poland',
        'PT': 'Portugal',
        'BE': 'Belgium',
        'AT': 'Austria',
        'NO': 'Norway',
        'DK': 'Denmark',
        'FI': 'Finland',
        'IE': 'Ireland',
        'CZ': 'Czech Republic',
        'GR': 'Greece',
        'IL': 'Israel'
      };
      const countryName = countryNames[sorted[i].country] || sorted[i].country;
      
      logDiv.textContent = `${timestamp} ${countryName} ${sorted[i].text}`;
      logWrapper.appendChild(logDiv);
    }, i * 30);
  }
}
    
let ws;
    
function connectWS() {
  ws = new WebSocket(
    location.protocol === "https:"
      ? `wss://${location.host}`
      : `ws://${location.host}`
  );
    
  ws.onmessage = e => {
    const data = JSON.parse(e.data);
    const timeDiff = Date.now() - lastSentTime;
    
    if (timeDiff > 1000) {
      renderLog(data, true);
    }
  };
}
    
async function sendLog(text) {
  lastSentTime = Date.now();
    
  const res = await fetch("/api/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text })
  });
    
  const newMessage = await res.json();
  renderLog(newMessage, true);
    
  setTimeout(() => {
    isTyping = false;
  }, 100);
}
</script>
</body>
</html>
