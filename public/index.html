<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>live-log</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <main id="term">
    <div id="logList" aria-live="polite"></div>

    <div id="inputBar">
      <input
        id="logInput"
        autocomplete="off"
        spellcheck="false"
        placeholder="type and hit enter"
      />
    </div>
  </main>

  <script>
    (() => {
      // 
      const API_BASE = "";
      const WS_URL = (location.protocol === "https:" ? "wss://" : "ws://") + 
location.host + "/ws";

      const list  = document.getElementById("logList");
      const input = document.getElementById("logInput");

      // 12/19/2025, 02:24:04 AM 
      const fmt = new Intl.DateTimeFormat("en-US", {
        month: "2-digit",
        day: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: true
      });

      const pad = (s) => String(s ?? "");

      function makeLine(ts, text, cls = "") {
        const div = document.createElement("div");
        div.className = "line " + cls;

        const d = new Date(ts);
        const left = fmt.format(d);
        div.textContent = `${left}  ${pad(text)}`;

        return div;
      }

      function append(ts, text, cls = "") {
        list.appendChild(makeLine(ts, text, cls));
        list.scrollTop = list.scrollHeight;
      }

      async function loadInitial() {
        try {
          const res = await fetch(`${API_BASE}/api/messages`, { cache: "no-store" });
          if (!res.ok) throw new Error("HTTP " + res.status);
          const rows = await res.json();

          list.innerHTML = "";
          // 
          append(Date.now(), "__________ is here for communal listening", "hint");

          rows.forEach(r => append(r.ts, r.text));
          list.scrollTop = 0;

          // 
          requestAnimationFrame(() => autoScrollDown(1400));
        } catch (e) {
          append(Date.now(), "[error] fetch failed", "err");
        }
      }

      function autoScrollDown(durationMs = 1200) {
        const start = performance.now();
        const from = 0;
        const to = Math.max(0, list.scrollHeight - list.clientHeight);

        function tick(t) {
          const p = Math.min(1, (t - start) / durationMs);
          // easeOutCubic
          const eased = 1 - Math.pow(1 - p, 3);
          list.scrollTop = from + (to - from) * eased;
          if (p < 1) requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      }

      // WebSocket
      const ws = new WebSocket(WS_URL);

      ws.addEventListener("message", (ev) => {
        try {
          const msg = JSON.parse(ev.data);

          // : { type:"message", ts, text, ... }
          if (msg.type === "message" || msg.type === "new") {
            append(msg.ts || Date.now(), msg.text || "");
          }
          if (msg.type === "error") {
            append(Date.now(), msg.message || "unknown", "err");
          }
        } catch {}
      });

      ws.addEventListener("close", () => {
        append(Date.now(), "[error] websocket closed", "err");
      });

      // Enter  (type: "post")
      input.addEventListener("keydown", (e) => {
        if (e.key !== "Enter") return;

        const text = input.value.trim();
        if (!text) return;

        input.value = "";

        try {
          ws.send(JSON.stringify({ type: "post", text }));
        } catch {
          append(Date.now(), "[error] send failed", "err");
        }
      });

      loadInitial();
      input.focus();
    })();
  </script>
</body>
</html>

