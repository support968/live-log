<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Communal Log</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #000;
    color: #ff0000;
    font-family: "Courier New", Courier, monospace;
    font-size: 13px;
    overflow: hidden;
  }

  #wrap {
    position: relative;
    width: 100vw;
    height: 100vh;
    padding: 40px;
    box-sizing: border-box;
  }

  #intro {
    text-align: center;
    margin-top: 60px;
    line-height: 1.6;
    white-space: pre;
  }

  #log-area {
    position: absolute;
    top: 180px;
    left: 40px;
    right: 40px;
    bottom: 80px;
    overflow: hidden;
  }

  .log-line {
    opacity: 0;
    transform: translateY(-6px);
    animation: drop 0.25s ease forwards;
    white-space: nowrap;
  }

  @keyframes drop {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  #input-line {
    position: absolute;
    bottom: 40px;
    left: 40px;
    color: #ff0000;
    white-space: nowrap;
  }

  #cursor {
    display: inline-block;
    width: 8px;
    margin-left: 2px;
    animation: blink 1s steps(1) infinite;
  }

  @keyframes blink {
    50% { opacity: 0; }
  }
</style>
</head>
<body>
<div id="wrap">

  <div id="intro"></div>

  <div id="log-area"></div>

  <div id="input-line" style="display:none;">
    <span id="input-text"></span><span id="cursor">▌</span>
  </div>

</div>

<script>
const introLines = [
  "Wake up... You are inside the system.",
  "KNOK, KNOK, KNOK,"
];

const introEl = document.getElementById("intro");
const logArea = document.getElementById("log-area");
const inputLine = document.getElementById("input-line");
const inputText = document.getElementById("input-text");

let introIndex = 0;
let charIndex = 0;

// ─────────────────────────────
// 타이핑 인트로
// ─────────────────────────────
function typeIntro() {
  if (introIndex >= introLines.length) {
    introEl.innerHTML += "\n\n";
    startLogs();
    return;
  }

  const line = introLines[introIndex];
  if (charIndex < line.length) {
    introEl.innerHTML += line[charIndex];
    charIndex++;
    setTimeout(typeIntro, 40);
  } else {
    introEl.innerHTML += "\n";
    introIndex++;
    charIndex = 0;
    setTimeout(typeIntro, 300);
  }
}

typeIntro();

// ─────────────────────────────
// 로그 렌더
// ─────────────────────────────
function renderLog(text, time, country, instant = false) {
  const line = document.createElement("div");
  line.className = "log-line";
  line.textContent = `${time}  ${country}  ${text}`;
  if (instant) line.style.animationDelay = "0s";
  logArea.prepend(line);
}

// ─────────────────────────────
// 초기 로그 로드 (한 줄씩 떨어짐)
// ─────────────────────────────
async function startLogs() {
  inputLine.style.display = "block";

  const res = await fetch("/api/messages");
  const logs = await res.json();

  let delay = 0;
  logs.reverse().forEach(log => {
    setTimeout(() => {
      renderLog(
        log.text,
        new Date(log.created_at).toLocaleString("en-US"),
        log.country || "UNKNOWN"
      );
    }, delay);
    delay += 60;
  });

  connectWS();
}

// ─────────────────────────────
// WebSocket
// ─────────────────────────────
function connectWS() {
  const ws = new WebSocket(
    (location.protocol === "https:" ? "wss://" : "ws://") + location.host
  );

  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    renderLog(
      data.text,
      new Date(data.created_at).toLocaleString("en-US"),
      data.country || "UNKNOWN"
    );
  };

  // 입력
  let buffer = "";
  document.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      if (buffer.trim()) {
        ws.send(JSON.stringify({ text: buffer }));
        buffer = "";
        inputText.textContent = "";
      }
    } else if (e.key === "Backspace") {
      buffer = buffer.slice(0, -1);
      inputText.textContent = buffer;
    } else if (e.key.length === 1) {
      buffer += e.key;
      inputText.textContent = buffer;
    }
  });
}
</script>
</body>
</html>

