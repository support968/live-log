<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>LIVE LOG</title>

<!-- IBM Plex Mono -->
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400&display=swap"
rel="stylesheet">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  color: #e00000;
  font-family: 'IBM Plex Mono', monospace;
  height: 100%;
  overflow: hidden;
}

#screen {
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

#header {
  flex-shrink: 0;
  text-align: center;
  margin-bottom: 30px;
}

#wakeup {
  font-size: 14px;
  margin-bottom: 10px;
}

#inputLine {
  font-size: 14px;
  height: 20px;
  display: none;
}

#typedText {
  white-space: pre;
}

#cursor {
  display: inline-block;
  width: 2px;
  height: 1em;
  background: #e00000;
  margin-left: 4px;
  animation: blink 1s steps(1) infinite;
}

@keyframes blink {
  50% { opacity: 0; }
}

#logWrapper {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  max-height: 40vh;
  overflow-y: auto;
  overflow-x: hidden;
  display: flex;
  flex-direction: column-reverse;
  padding: 20px;
}

#logWrapper::-webkit-scrollbar {
  width: 6px;
}

#logWrapper::-webkit-scrollbar-track {
  background: #000;
}

#logWrapper::-webkit-scrollbar-thumb {
  background: #330000;
}

.log {
  font-size: 13px;
  line-height: 1.55;
  letter-spacing: 0.02em;
  opacity: 0;  
  transform: translateY(-6px);
  animation: drop 0.35s ease forwards;
  text-align: center;
  margin-bottom: 2px;
}

@keyframes drop {  
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

</style>
</head>
  
<body>
<div id="screen">
  <div id="header">
    <div id="wakeup"></div>
    <div id="inputLine">
      <span id="typedText"></span><span id="cursor"></span>
    </div>
  </div>

  <div id="logWrapper"></div>
</div>
  
<script>
const wakeupEl = document.getElementById("wakeup");
const inputLine = document.getElementById("inputLine");
const typedTextEl = document.getElementById("typedText");
const logWrapper = document.getElementById("logWrapper");
  
const wakeupText = "Wake up";
let i = 0;
let lastSentTime = 0;
  
function typeWakeUp() {
  if (i < wakeupText.length) {
    wakeupEl.textContent += wakeupText[i++];
    setTimeout(typeWakeUp, 120);
  } else {
    typeDots(0);
  }
}  
 
function typeDots(count) {
  if (count < 3) {
    wakeupEl.textContent += ".";
    setTimeout(() => typeDots(count + 1), 500);
  } else {
    setTimeout(() => {   
      inputLine.style.display = "block";
      enableTyping();
      connectWS();
      
      setTimeout(() => {
        loadInitialLogs();
      }, 2000);
  
    }, 500);
  }
}

typeWakeUp();
  
let buffer = "";
let isTyping = false;
   
function enableTyping() {
  document.addEventListener("keydown", e => {
    if (isTyping) return;
    
    if (e.key === "Enter") {
      if (!buffer.trim()) return;
      isTyping = true;
      sendLog(buffer.trim());
      buffer = "";
      typedTextEl.textContent = "";
      return;
    }
  
    if (e.key === "Backspace") {
      buffer = buffer.slice(0, -1);
      typedTextEl.textContent = buffer;
      return;
    }

    if (/^[a-zA-Z0-9 .,!?'-]$/.test(e.key)) {
      buffer += e.key;
      typedTextEl.textContent = buffer;
    }  
  });
}
  
function renderLog({ created_at, country, text }) {
  const d = new Date(created_at);
      
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  const year = d.getFullYear();
  const hours = String(d.getHours()).padStart(2, '0');
  const minutes = String(d.getMinutes()).padStart(2, '0');
  const seconds = String(d.getSeconds()).padStart(2, '0');
 
  const timestamp = `${month}/${day}/${year}, ${hours}:${minutes}:${seconds}`;

  const line = document.createElement("div");
  line.className = "log";
  line.textContent = `${timestamp} ${country} ${text}`;
  
  logWrapper.insertBefore(line, logWrapper.firstChild);
}

async function loadInitialLogs() {
  const res = await fetch("/api/messages");
  const data = await res.json();
      
  const sorted = data.sort((a, b) => b.created_at - a.created_at);
     
  for (let i = 0; i < sorted.length; i++) {
    setTimeout(() => {
      renderLog(sorted[i]); 
    }, i * 80);
  }
}

let ws;
     
function connectWS() {
  ws = new WebSocket(
    location.protocol === "https:"
      ? `wss://${location.host}` 
      : `ws://${location.host}`
  );
  
  ws.onmessage = e => {
    const data = JSON.parse(e.data);
    const timeDiff = Date.now() - lastSentTime;
    
    if (timeDiff > 1000) {
      renderLog(data);
    }
  };
}
  
async function sendLog(text) {
  lastSentTime = Date.now();
  
  const res = await fetch("/api/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json" },   
    body: JSON.stringify({ text })
  });
  
  const newMessage = await res.json();
  renderLog(newMessage);
  
  setTimeout(() => {
    isTyping = false;
  }, 100);
}
</script> 
</body>
</html>
