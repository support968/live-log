<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Live Log</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400&display=swap" 
rel="stylesheet">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  color: #ff1a1a;
  font-family: "IBM Plex Mono", monospace;
  height: 100%;
}

body {
  display: flex;
  justify-content: center;
  align-items: center;
}

#wrap {
  text-align: center;
  width: 100%;
}

#wakeup {
  font-size: 14px;
  margin-bottom: 18px;
  min-height: 18px;
}

#input-line {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 18px;
  margin-bottom: 22px;
}

#typed {
  font-size: 14px;
  white-space: pre;
}

#cursor {
  width: 1px;              /* ✔ 두께 30% 감소 */
  height: 16px;
  background: #ff1a1a;
  margin-left: 6px;
  animation: blink 1s steps(1) infinite;
  display: none;
}

@keyframes blink {
  50% { opacity: 0; }
}

#logs {
  font-size: 13px;
  line-height: 1.55;       /* ✔ 레퍼런스에 맞춘 행간 */
  letter-spacing: 0.02em;  /* ✔ 글자 간격 */
}

.log {
  opacity: 0;
  transform: translateY(-8px);
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.log.show {
  opacity: 1;
  transform: translateY(0);
}
</style>
</head>

<body>
<div id="wrap">

  <div id="wakeup"></div>

  <div id="input-line">
    <span id="typed"></span>
    <span id="cursor"></span>
  </div>

  <div id="logs"></div>

</div>

<script>
const wakeupEl = document.getElementById("wakeup");
const typedEl  = document.getElementById("typed");
const cursorEl = document.getElementById("cursor");
const logsEl   = document.getElementById("logs");

let buffer = "";
let readyForInput = false;

// ─────────────────────────────
// Utils
// ─────────────────────────────
const sleep = ms => new Promise(r => setTimeout(r, ms));

// ─────────────────────────────
// Wake up typing
// ─────────────────────────────
async function playWakeup() {
  const text = "Wake up";
  for (const c of text) {
    wakeupEl.textContent += c;
    await sleep(90);
  }

  for (let i = 0; i < 3; i++) {
    await sleep(350);
    wakeupEl.textContent += ".";
  }

  await sleep(400);
  cursorEl.style.display = "inline-block";
  readyForInput = true;
}

// ─────────────────────────────
// Initial logs (animated)
// ─────────────────────────────
async function loadLogs() {
  const res = await fetch("/api/messages");
  const data = await res.json();

  // 오래된 것부터 → 애니메이션
  for (let i = data.length - 1; i >= 0; i--) {
    addLog(data[i]);
    await sleep(120);
  }
}

// ─────────────────────────────
// Add log line
// ─────────────────────────────
function addLog(item, instant = false) {
  if (!item?.text || !item?.created_at) return;

  const time = new Date(item.created_at).toLocaleString("en-US", {
    hour12: true
  });

  const div = document.createElement("div");
  div.className = "log";
  div.textContent = `${time} SOUTH KOREA ${item.text}`;

  logsEl.prepend(div);

  if (instant) {
    div.classList.add("show");
  } else {
    requestAnimationFrame(() => div.classList.add("show"));
  }
}

// ─────────────────────────────
// Input typing
// ─────────────────────────────
document.addEventListener("keydown", async e => {
  if (!readyForInput) return;

  if (e.key === "Backspace") {
    buffer = buffer.slice(0, -1);
    typedEl.textContent = buffer;
    return;
  }

  if (e.key === "Enter") {
    if (!buffer.trim()) return;

    await fetch("/api/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: buffer })
    });

    buffer = "";
    typedEl.textContent = "";
    return;
  }

  if (e.key.length === 1 && /^[a-zA-Z0-9 .,!?'"]$/.test(e.key)) {
    buffer += e.key;
    typedEl.textContent = buffer;
  }
});

// ─────────────────────────────
// WebSocket (real-time)
// ─────────────────────────────
const ws = new WebSocket(
  location.protocol === "https:"
    ? `wss://${location.host}`
    : `ws://${location.host}`
);

ws.onmessage = e => {
  const item = JSON.parse(e.data);
  addLog(item, true);
};

// ─────────────────────────────
// Start
// ─────────────────────────────
(async () => {
  await playWakeup();
  await loadLogs();
})();
</script>
</body>
</html>

