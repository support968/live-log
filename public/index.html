<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Communal Listening</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  color: red;
  font-family: "Courier New", monospace;
  overflow: hidden;
}

#container {
  padding: 40px;
}

#intro {
  text-align: center;
  margin-top: 80px;
  white-space: pre;
}

#input-line {
  display: none;
  margin: 40px auto;
  width: 60%;
  border-bottom: 1px solid red;
  padding-bottom: 5px;
}

#input {
  background: none;
  border: none;
  outline: none;
  color: red;
  font-family: inherit;
  font-size: 16px;
  width: 100%;
}

#logs {
  margin-top: 40px;
}

.log {
  opacity: 0;
  transform: translateY(-10px);
  animation: drop 0.15s ease forwards;
}

@keyframes drop {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.cursor {
  display: inline-block;
  width: 10px;
  animation: blink 1s steps(2) infinite;
}

@keyframes blink {
  50% { opacity: 0; }
}
</style>
</head>
<body>
<div id="container">
  <div id="intro"></div>

  <div id="input-line">
    <input id="input" autocomplete="off" />
    <span class="cursor">|</span>
  </div>

  <div id="logs"></div>
</div>

<script>
const introText = [
  "Wake up . . . You are inside the system.",
  "",
  "KNOK, KNOK, KNOK"
];

const introEl = document.getElementById("intro");
const inputLine = document.getElementById("input-line");
const input = document.getElementById("input");
const logsEl = document.getElementById("logs");

let line = 0;
let char = 0;

function typeIntro() {
  if (line >= introText.length) {
    inputLine.style.display = "block";
    input.focus();
    loadLogs();
    return;
  }

  if (char < introText[line].length) {
    introEl.textContent += introText[line][char++];
    setTimeout(typeIntro, 40);
  } else {
    introEl.textContent += "\n";
    line++;
    char = 0;
    setTimeout(typeIntro, 300);
  }
}

typeIntro();

/* ─────────────────────────────
   Logs
───────────────────────────── */
function addLog(log) {
  const el = document.createElement("div");
  el.className = "log";
  const time = new Date(log.created_at).toLocaleString();
  el.textContent = `${time} ${log.country} ${log.text}`;
  logsEl.prepend(el);
}

async function loadLogs() {
  const res = await fetch("/api/messages");
  const data = await res.json();
  data.reverse().forEach((log, i) => {
    setTimeout(() => addLog(log), i * 30);
  });
}

/* ─────────────────────────────
   WebSocket
───────────────────────────── */
const ws = new WebSocket(
  (location.protocol === "https:" ? "wss://" : "ws://") +
  location.host
);

ws.onmessage = (e) => {
  addLog(JSON.parse(e.data));
};

input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    const text = input.value.trim();
    if (!text) return;
    ws.send(JSON.stringify({ text }));
    input.value = "";
  }
});
</script>
</body>
</html>

