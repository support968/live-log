<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Log</title>
  <style>
    html, body { height: 100%; margin: 0; background:#000; color:#fff; 
font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 
"Liberation Mono", monospace; }
    #liveLog { height: 100%; display: flex; flex-direction: column; }
    #logList { flex: 1; overflow: auto; padding: 16px; line-height: 1.6; 
white-space: pre-wrap; }
    #logInput { width: 360px; max-width: calc(100% - 32px); margin: 12px 
16px; padding: 8px 10px; border: 0; outline: none; }
    .err { color:#ff3b30; }
  </style>
</head>
<body>
  <div id="liveLog">
    <div id="logList"></div>
    <input id="logInput" autocomplete="off" placeholder="type and hit 
enter" />
  </div>

  <script>
    // 중요: 같은 도메인(Render)에서 실행되게 구성 (Cargo에서 JS 안되는 
문제 회피)
    const API_BASE = "";
    const WS_URL = (location.protocol === "https:" ? "wss://" : "ws://") + 
location.host + "/ws";

    const list = document.getElementById("logList");
    const input = document.getElementById("logInput");

    const append = (ts, text, cls) => {
      const div = document.createElement("div");
      if (cls) div.className = cls;
      div.textContent = `${new Date(ts).toLocaleString()}  ${text}`;
      list.appendChild(div);
      list.scrollTop = list.scrollHeight;
    };

    const loadInitial = async () => {
      try {
        const res = await fetch(`${API_BASE}/api/messages`, { cache: 
"no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rows = await res.json();
        list.innerHTML = "";
        rows.forEach(r => append(r.ts, r.text));
      } catch (e) {
        append(Date.now(), `[error] fetch failed`, "err");
      }
    };

    const ws = new WebSocket(WS_URL);

    ws.addEventListener("open", () => { /* no-op */ });

    ws.addEventListener("message", (ev) => {
      try {
        const msg = JSON.parse(ev.data);
        if (msg?.type === "new") append(msg.ts, msg.text);
        if (msg?.type === "error") append(Date.now(), `[error] 
${msg.message || "unknown"}`, "err");
      } catch {}
    });

    ws.addEventListener("close", () => {
      append(Date.now(), `[error] websocket closed`, "err");
    });

    input.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      const text = input.value.trim();
      if (!text) return;
      input.value = "";
      try {
        ws.send(JSON.stringify({ text }));
      } catch {
        append(Date.now(), `[error] send failed`, "err");
      }
    });

    loadInitial();
  </script>
</body>
</html>

