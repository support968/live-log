<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Communal Listening</title>

<style>
:root{
  --bg:#000;
  --fg:#ff2a2a;
  --font: 12px/1.6 "Courier New", Courier, monospace;
}

*{ box-sizing:border-box; }

html,body{
  margin:0;
  padding:0;
  width:100%;
  height:100%;
  background:var(--bg);
  color:var(--fg);
  font:var(--font);
  overflow:hidden;
}


#topbar{
  position:fixed;
  top:24px;
  left:24px;
  display:flex;
  align-items:center;
  gap:14px;
  z-index:10;
}

#status{
  white-space:nowrap;
}

#promptLine{
  width:140px;               
  height:16px;
  border-bottom:1px solid var(--fg);
  position:relative;
}

#caret{
  position:absolute;
  right:0;
  bottom:-1px;
  width:1px;
  height:16px;
  background:var(--fg);
  animation:blink 1s steps(1) infinite;
}

@keyframes blink{
  50%{ opacity:0; }
}


#logWrap{
  position:absolute;
  top:80px;
  left:24px;
  right:24px;
  bottom:24px;
  overflow:hidden;
}

#log{
  display:flex;
  flex-direction:column;
  gap:2px;
  transform:translateY(30px);
  opacity:0;
  animation:dropIn 1.4s ease forwards;
}

@keyframes dropIn{
  to{
    transform:translateY(0);
    opacity:1;
  }
}

.line{
  white-space:pre;
}

/* hidden input */
#hiddenInput{
  position:absolute;
  opacity:0;
  pointer-events:none;
}
</style>
</head>

<body>

<div id="topbar">
  <div id="status">OUR SPECIAL _____ </div>
  <div id="promptLine"><div id="caret"></div></div>
</div>

<div id="logWrap">
  <div id="log"></div>
</div>

<input id="hiddenInput" autocomplete="off" />

<script>
const logEl = document.getElementById("log");
const input = document.getElementById("hiddenInput");
const caret = document.getElementById("caret");


document.body.addEventListener("click", ()=>input.focus());
input.focus();


const wsProto = location.protocol === "https:" ? "wss" : "ws";
const ws = new WebSocket(wsProto + "://" + location.host + "/ws");


fetch("/api/messages")
  .then(r=>r.json())
  .then(rows=>{
    rows.forEach(r=>append(r.ts, r.text));
    scrollBottom();
  });

ws.onmessage = e=>{
  const msg = JSON.parse(e.data);
  if(msg.type === "message"){
    append(msg.ts, msg.text);
    scrollBottom();
  }
};

function append(ts,text){
  const d = new Date(ts);
  const time = d.toLocaleString("en-US",{
    month:"2-digit",
    day:"2-digit",
    year:"numeric",
    hour:"2-digit",
    minute:"2-digit",
    second:"2-digit",
    hour12:true
  });

  const div = document.createElement("div");
  div.className = "line";
  div.textContent = `${time}  ${text}`;
  logEl.appendChild(div);
}


function scrollBottom(){
  logEl.parentElement.scrollTop = logEl.parentElement.scrollHeight;
}


input.addEventListener("keydown", e=>{
  if(e.key !== "Enter") return;

  const text = input.value.trim();
  if(!text) return;

  ws.send(JSON.stringify({
    type:"post",
    text
  }));

  input.value="";
});
</script>

</body>
</html>

