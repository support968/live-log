const express = require('express');
const http = require('http');
const WebSocket = require('ws');
const cors = require('cors');
const sqlite3 = require('sqlite3').verbose();
const path = require('path');

const app = express();
const server = http.createServer(app);
const wss = new WebSocket.Server({ server });

const PORT = process.env.PORT || 3000;
const DB_FILE = path.join(__dirname, 'data.db');

app.use(cors());
app.use(express.json());
app.use(express.static('public'));

// SQLite 초기화
const db = new sqlite3.Database(DB_FILE);

db.serialize(() => {
  db.run(`
    CREATE TABLE IF NOT EXISTS messages (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      country TEXT NOT NULL,
      text TEXT NOT NULL,
      created_at INTEGER NOT NULL
    )
  `);
});

// 국가 감지 함수 (기본값 KR)
async function detectCountry(req) {
  const ip = req.headers['x-forwarded-for'] || req.connection.remoteAddress;
  try {
    const response = await fetch(`https://ipapi.co/${ip}/json/`);
    const data = await response.json();
    return data.country_code || 'KR';
  } catch (error) {
    return 'KR';
  }
}

// 모든 로그 가져오기
app.get('/api/messages', (req, res) => {
  db.all('SELECT * FROM messages ORDER BY created_at ASC', [], (err, rows) => {
    if (err) {
      return res.status(500).json({ error: 'Failed to read messages' });
    }
    res.json(rows);
  });
});

// 새 로그 추가
app.post('/api/messages', async (req, res) => {
  const { text } = req.body;
  const country = await detectCountry(req);
  const created_at = Date.now();

  db.run(
    'INSERT INTO messages (country, text, created_at) VALUES (?, ?, ?)',
    [country, text, created_at],
    function(err) {
      if (err) {
        return res.status(500).json({ error: 'Failed to save message' });
      }

      const newMessage = {
        id: this.lastID,
        country,
        text,
        created_at
      };

      // WebSocket으로 모든 클라이언트에게 전송
      wss.clients.forEach(client => {
        if (client.readyState === WebSocket.OPEN) {
          client.send(JSON.stringify(newMessage));
        }
      });

      res.json(newMessage);
    }
  );
});

server.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
});
