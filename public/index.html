<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Live Log</title>

<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400&display=swap" 
rel="stylesheet">

<style>
  body {
    margin: 0;
    background: black;
    color: red;
    font-family: "IBM Plex Mono", monospace;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .wrap {
    text-align: center;
    width: 600px;
  }

  .wake {
    font-size: 14px;
    min-height: 18px;
    margin-bottom: 14px;
  }

  .input-line {
    font-size: 14px;
    min-height: 18px;
    margin-bottom: 18px;
  }

  .cursor {
    display: inline-block;
    width: 5px;   /* 30% thinner */
    height: 14px;
    background: red;
    animation: blink 1s step-start infinite;
    vertical-align: bottom;
  }

  @keyframes blink {
    50% { opacity: 0; }
  }

  .logs {
    font-size: 12px;
    line-height: 1.6;
    letter-spacing: 0.02em;
  }

  .log {
    opacity: 0;
    transform: translateY(-6px);
    transition: all 0.4s ease;
  }

  .log.show {
    opacity: 1;
    transform: translateY(0);
  }
</style>
</head>

<body>
<div class="wrap">
  <div id="wake" class="wake"></div>

  <div id="inputLine" class="input-line" style="display:none;">
    <span id="typed"></span><span class="cursor"></span>
  </div>

  <div id="logs" class="logs"></div>
</div>

<script>
const wakeEl = document.getElementById("wake");
const inputLine = document.getElementById("inputLine");
const typedEl = document.getElementById("typed");
const logsEl = document.getElementById("logs");

let buffer = "";

const sleep = ms => new Promise(r => setTimeout(r, ms));

/* 1. Wake up 타이핑 */
async function typeWakeUp() {
  const text = "Wake up";
  for (let i = 0; i < text.length; i++) {
    wakeEl.textContent += text[i];
    await sleep(120);
  }
  for (let i = 0; i < 3; i++) {
    await sleep(400);
    wakeEl.textContent += ".";
  }
}

/* 2. 입력 시작 */
function enableTyping() {
  inputLine.style.display = "block";
  window.addEventListener("keydown", onKey);
}

/* 3. 키 입력 처리 */
function onKey(e) {
  if (e.key === "Backspace") {
    buffer = buffer.slice(0, -1);
  } else if (e.key === "Enter") {
    submit();
    return;
  } else if (e.key.length === 1 && /^[a-zA-Z0-9 .,!?'-]$/.test(e.key)) {
    buffer += e.key;
  }
  typedEl.textContent = buffer;
}

/* 4. 서버로 전송 */
async function submit() {
  if (!buffer.trim()) return;

  await fetch("/api/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text: buffer })
  });

  buffer = "";
  typedEl.textContent = "";
}

/* 5. 로그 불러오기 */
async function loadLogs() {
  const res = await fetch("/api/messages");
  const data = await res.json();

  data.reverse();

  for (const item of data) {
    const time = new Date(item.created_at).toLocaleString("en-US", {
      hour12: true
    });

    const div = document.createElement("div");
    div.className = "log";
    div.textContent = `${time} SOUTH KOREA ${item.text}`;

    logsEl.appendChild(div);
    requestAnimationFrame(() => div.classList.add("show"));
    await sleep(120);
  }
}

/* 전체 시퀀스 */
(async function start() {
  await typeWakeUp();
  await sleep(300);
  enableTyping();
  await sleep(600);
  await loadLogs();
})();
</script>
</body>
</html>

