<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Guestbook</title>

<style>
:root{
  --bg:#000;
  --red:#ff2a2a;
  --font: 22px/1.6 "Courier New", Courier, monospace;
  --thin: 1px;
}

*{ box-sizing:border-box; }
html,body{
  margin:0; padding:0;
  width:100%; height:100%;
  background:var(--bg);
  color:var(--red);
  font:var(--font);
  overflow:hidden;
}

/* layout */
#wrap{
  position:fixed;
  inset:0;
  padding:28px 28px 22px 28px;
}

/* top line */
#top{
  display:flex;
  align-items:flex-end;
  gap:18px;
  white-space:nowrap;
}

#brand{
  letter-spacing:1px;
}

#name{
  width:140px;                 /* 레퍼런스처럼 짧은 칸 */
  background:transparent;
  border:none;
  border-bottom:var(--thin) solid var(--red);
  outline:none;
  color:var(--red);
  font:inherit;
  padding:0 0 2px 0;
  caret-color:var(--red);
}

#rule{
  flex:1;
  border-bottom:var(--thin) solid var(--red);
  transform:translateY(-6px);  /* 라인 baseline 맞춤 */
  opacity:0.95;
}

/* log area */
#logWrap{
  position:absolute;
  left:28px; right:28px;
  top:92px; bottom:22px;
  overflow:hidden;             /* 레퍼런스처럼 스크롤바 안보이게 */
}

#logScroller{
  width:100%;
  height:100%;
  overflow:auto;               /* 내부는 스크롤 가능 */
  scrollbar-width:none;
}
#logScroller::-webkit-scrollbar{ width:0; height:0; }

#lineList{
  white-space:pre;
}

.line{
  margin:0;
  padding:0;
}

/* spacing closer to reference */
@media (max-width: 900px){
  :root{ --font: 18px/1.6 "Courier New", Courier, monospace; }
  #name{ width:120px; }
}
</style>
</head>

<body>
<div id="wrap">

  <div id="top">
    <div id="brand">OUR SPECIAL</div>
    <input id="name" type="text" autocomplete="off" spellcheck="false" />
    <div id="rule"></div>
  </div>

  <div id="logWrap">
    <div id="logScroller">
      <div id="lineList"></div>
    </div>
  </div>

</div>

<script>
const list = document.getElementById("lineList");
const scroller = document.getElementById("logScroller");
const nameInput = document.getElementById("name");

/* focus */
function focusInput(){ nameInput.focus({ preventScroll:true }); }
document.addEventListener("click", focusInput);
window.addEventListener("load", focusInput);

/* ws */
const wsProto = location.protocol === "https:" ? "wss" : "ws";
const ws = new WebSocket(wsProto + "://" + location.host + "/ws");

/* format like reference: 12/19/2025, 03:18:52 AM */
function fmt(ts){
  const d = new Date(ts);
  return d.toLocaleString("en-US", {
    month:"2-digit", day:"2-digit", year:"numeric",
    hour:"2-digit", minute:"2-digit", second:"2-digit",
    hour12:true
  });
}

function append(ts, text){
  const div = document.createElement("div");
  div.className = "line";
  div.textContent = `${fmt(ts)}  ${text}`;
  list.appendChild(div);
}

/* smooth scroll animation (reference-like “drop/scroll down”) */
function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

function animateScrollToBottom(durationMs=1600){
  const start = scroller.scrollTop;
  const end = scroller.scrollHeight - scroller.clientHeight;
  const delta = end - start;
  const t0 = performance.now();

  function step(now){
    const p = Math.min(1, (now - t0) / durationMs);
    scroller.scrollTop = start + delta * easeOutCubic(p);
    if(p < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* keep near-bottom on new messages (if user is already near bottom) */
function isNearBottom(px=60){
  return (scroller.scrollHeight - scroller.clientHeight - scroller.scrollTop) < px;
}
function jumpBottom(){ scroller.scrollTop = scroller.scrollHeight; }

/* initial load */
fetch("/api/messages", { cache:"no-store" })
  .then(r => r.json())
  .then(rows => {
    rows.forEach(r => append(r.ts, r.text));
    scroller.scrollTop = 0;         // 시작은 위
    animateScrollToBottom(1700);    // 그리고 아래로 쭉 내려감
  })
  .catch(()=>{});

/* ws events */
ws.addEventListener("message", (ev) => {
  let msg;
  try { msg = JSON.parse(ev.data); } catch { return; }
  if(msg.type !== "message") return;

  const stick = isNearBottom();
  append(msg.ts, msg.text);
  if(stick) jumpBottom();
});

/* send on Enter (and keep typing visible) */
nameInput.addEventListener("keydown", (e) => {
  if(e.key !== "Enter") return;

  const text = nameInput.value.trim();
  if(!text) return;

  ws.send(JSON.stringify({ type:"post", text }));
  nameInput.value = "";
});
</script>
</body>
</html>

